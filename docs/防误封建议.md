# 防止误封正常访问的建议

## 已修复的问题

### 1. ✅ 状态码检测优化
**问题**：之前统计所有4xx/5xx错误，容易将正常404误判为攻击
**修复**：现在只统计可疑错误码（403, 500-505），排除了常见的正常错误：
- 401（认证保护）
- 404（资源未找到）
- 405（方法不允许）

### 2. ✅ 免费WAF拦截分数降低
**问题**：免费WAF可能误拦截，但之前无条件高分标记
**修复**：免费WAF拦截分数减半（默认5→2.5），需要更多次拦截才会达到威胁等级

### 3. ✅ 恶意UA规则精简
**问题**：之前包含curl、wget、axios等合法工具的UA
**修复**：移除了这些常见的合法工具UA，只保留真正的攻击工具

### 4. ✅ SQL注入规则精确化
**问题**：`or.*=.*`、`and.*=.*`等规则过于宽泛，会匹配正常查询参数
**修复**：使用更精确的规则，如`or 1=1`、`' or '1'='1`等

## 配置建议

### 白名单设置（重要！）

#### 1. 白名单文件 `white.txt`
在 `white.txt` 中添加可信IP：
```
# 管理员IP
1.2.3.4

# 办公室网络（CIDR）
10.0.0.0/8
192.168.0.0/16

# 搜索引擎爬虫（建议添加）
# Google Bot
66.249.64.0/19
# Bing Bot
40.77.167.0/24
# 百度爬虫
180.76.0.0/16
220.181.0.0/16
```

#### 2. 常见需要加白名单的情况
- **搜索引擎爬虫**：Google、Bing、百度、360等
- **监控服务**：网站监控、CDN、负载均衡健康检查
- **API调用方**：合作伙伴的服务器IP
- **内部服务**：微服务、后台任务的IP

### 阈值调整（config.yaml）

#### 1. 高频访问检测
```yaml
thresholds:
  frequency:
    window_seconds: 300  # 时间窗口（秒）
    max_requests: 100    # 最大请求数
```

**场景调整**：
- **普通网站**：默认值（300秒/100次）合适
- **API服务**：建议提高至500-1000次
- **单页应用（SPA）**：建议提高至200-300次
- **静态网站**：可以降低至50次

#### 2. 异常状态码检测
```yaml
thresholds:
  error_rate:
    window_seconds: 60   # 时间窗口（秒）
    max_errors: 50       # 最大错误数
```

**说明**：
- 现在只统计403、500-505错误
- 如果经常出现服务器错误（500），可以适当提高阈值

#### 3. 敏感路径扫描
```yaml
thresholds:
  path_scan:
    max_sensitive_hits: 5  # 访问敏感路径次数
```

**说明**：
- 需要访问5次不同的敏感路径才触发
- 如果有合法后台管理，建议将管理员IP加入白名单

#### 4. 威胁等级阈值
```yaml
threat_scores:
  frequency_violation: 3   # 高频访问
  sensitive_path: 4        # 敏感路径扫描
  malicious_ua: 4          # 恶意UA
  error_flood: 2           # 大量错误
  sql_injection: 5         # SQL注入特征
  waf_block: 5             # WAF拦截（付费版）
  ssh_bruteforce: 5        # SSH暴力破解

threat_levels:
  LOW: 2       # 低危
  MEDIUM: 4    # 中危
  HIGH: 6      # 高危
  CRITICAL: 8  # 严重
```

**调整建议**：
- **宽松模式**：提高等级阈值（LOW: 3, MEDIUM: 6, HIGH: 9, CRITICAL: 12）
- **严格模式**：保持默认或降低阈值

## 如何判断是否误封

### 1. 检查日志
```bash
# 查看最近的威胁IP
tail -50 /www/server/ipcollect/ip.txt

# 查看日志
tail -100 /www/server/ipcollect/logs/ipcollect.log
```

### 2. 检查数据库
```bash
# 进入项目目录
cd /www/server/ipcollect

# 查询威胁IP详情
sqlite3 data/ipcollect.db "SELECT ip, threat_level, reasons, hit_count FROM threat_ips ORDER BY score DESC LIMIT 20;"
```

### 3. 常见误封特征
- **原因是"免费WAF拦截"**：可能是误拦截，检查访问路径是否合法
- **大量404错误（已修复）**：新版本已不再统计404
- **高频访问且IP是CDN/爬虫**：应该加入白名单
- **正常管理员IP被封**：将管理IP加入白名单

## 紧急解封

如果误封了重要IP：

### 方法1：添加到白名单
```bash
# 编辑白名单文件
nano /www/server/ipcollect/white.txt

# 添加IP
1.2.3.4

# 重启服务
systemctl restart ipcollect
```

### 方法2：从数据库删除
```bash
cd /www/server/ipcollect
sqlite3 data/ipcollect.db "DELETE FROM threat_ips WHERE ip='1.2.3.4';"

# 从导出文件中移除
sed -i '/1.2.3.4/d' ip.txt
```

### 方法3：临时禁用检测
```yaml
# 编辑 config.yaml
# 注释掉某个分析器
log_sources:
  free_waf:
    enabled: false  # 暂时禁用免费WAF分析
```

## 最佳实践

1. **先观察再行动**：部署初期建议只观察（不实际封禁），确认准确性
2. **逐步收紧**：从宽松阈值开始，逐步调整
3. **定期审查**：每周检查威胁IP列表，发现误封及时调整
4. **完善白名单**：将所有可信IP/CIDR加入白名单
5. **监控告警**：关注日志中的"威胁IP"提示，及时处理

## 联系支持

如有问题，请联系：
- 作者：sinma
- 网站：https://www.carefreecode.com/
- QQ：42033223
